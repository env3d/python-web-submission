<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Python Submission</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/css/ace.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/css/jquery.terminal.min.css" rel="stylesheet"/>
    <style type="text/css" media="screen">
      body {
	  max-width: 90%;
	  overflow: hidden;
      }
      
      #loading {
	  top: 0;
	  left: 0;	 
	  position: fixed;
	  height: 100vh;
	  width: 100vw;
	  background-color: rgba(128,128,128,0.6);
	  z-index: 99999;
	  text-align: center;
	  font-size: 10em;	  
      }

      #container {
	  display: grid;
	  height: 100vh;
	  width: 100%;
	  grid-template-areas: 'run test'
			       'editor output'
			       'console console';
      }
      
      #run {
	  grid-area: run;
      }
      
      #test {
	  grid-area: test;
      }
      
      #editor {
	  grid-area: editor;
	  width: 60%;
      }
      
      #output {
	  grid-area: output;
	  background-color: rgb(80,80,80);
	  color: white;
	  overflow: scroll;
	  margin: 0;
      }

      #output * {
	  margin: 1em;
      }
      
      #console {
	  margin: 0;
	  grid-area: console;
	  overflow: auto;
	  margin-bottom: 5%;
      }
      
    </style>
  </head>
  <body onload="load()" onresize="resize()">
    <div id="container">
      <div id="run">
	<button onclick="PWS.runtime()">Run</button>
      </div>
      <div id="test">
	<button onclick="PWS.runtest()">Test and Submit</button>
      </div>
      <div id="editor"></div>
      <div id="output">
	<pre id="text"></pre>
      </div>
      
      <div id="console"></div>
    </div>

    <div id="loading">
      Grading...
    </div>
    <script src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/src-min-noconflict/ace.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/src-min-noconflict/ext-language_tools.js"></script>
    <script src="third-party/skulpt-dist-master/skulpt.js"></script>
    <script src="third-party/skulpt-dist-master/skulpt-stdlib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/js/jquery.terminal.min.js"></script>
    <script src="https://unpkg.com/js-polyfills/keyboard.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/wcwidth.js"></script>


    <script src="skulpt-run.js"></script>
    <script src="pyodide-run.js"></script>
    <script src="repl.js"></script>
    
    <script>
      // PWS is the global object this module exports
      // all configuration should be here.
      // Most of the configuration are set in load()
      var PWS = {
	assignmentRoot: null,
	fontsize: null,
	editorwidth: null,
	consoleheight: null,
	runtime: null,
	runtest: null,
	terminal: null,	
      }
      
      function resize() {
	// adjust the width of the editor and container
	let editorWidth = window.getComputedStyle(document.getElementById('editor')).width.replace('px','');	
	let containerWidth = window.getComputedStyle(document.getElementById('container')).width.replace('px','');
	document.getElementById('editor').style.width = (containerWidth * PWS.editorwidth)+'px';
	document.getElementById('output').style.width = (containerWidth * (1 - PWS.editorwidth))+'px';
	//document.getElementById('output').style.width = (containerWidth-editorWidth)+'px';
	
	let containerHeight = window.getComputedStyle(document.getElementById('container')).height.replace('px','');
	// adjust the height of all the major elements: run, test, editor, output, console	
	document.getElementById('run').style.height = (containerHeight * 0.05)+'px';	
	document.getElementById('test').style.height = (containerHeight * 0.05)+'px';		
	document.getElementById('output').style.height = (containerHeight * (0.9 - PWS.consoleheight) )+'px';
	document.getElementById('output').style.margin = 0;
	document.getElementById('editor').style.height = (containerHeight * (0.9 - PWS.consoleheight) )+'px';		
	document.getElementById('console').style.height = (containerHeight * PWS.consoleheight)+'px';	
      }
      
      async function load() {
      
	// Set the default interactive python runtime
	PWS.runtime = runSkulpt;
	PWS.runtest = runTest;
	ace.require("ace/ext/language_tools");	
        PWS.editor = ace.edit("editor");
	PWS.editor.setOptions({
	  enableBasicAutocompletion: true
	});
	    
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	PWS.assignmentRoot = urlParams.get('path') || "labs/lab1";
	
	PWS.consoleheight = parseFloat(urlParams.get('consoleheight')) || 0.2;
	PWS.editorwidth = parseFloat(urlParams.get('editorwidth')) || 0.6;
	
	PWS.fontsize = parseInt(urlParams.get('fontsize')) || 12;
	PWS.editor.setFontSize(PWS.fontsize);
	document.getElementById('output').style.fontSize = PWS.fontsize+"px";

	let hashParams = location.hash !== '' ?
	    new URLSearchParams(location.hash.slice(1)) :
	    new URLSearchParams()
	PWS.launch_id = hashParams.get('launch_id')
	PWS.tool_base = hashParams.get('tool_base')
	
	// history.pushState(null, null, `${window.location.pathname}?path=${PWS.assignmentRoot}`);	

	PWS.editor.setAutoScrollEditorIntoView(true);
	PWS.editor.setTheme("ace/theme/monokai");	
	PWS.editor.session.setMode("ace/mode/python");
	
	let staticWordCompleter = {
	  getCompletions: function(editor, session, pos, prefix, callback) {
	    wordList = [];
	    if (Sk.globals) {
	      wordList = Object.keys(Sk.globals).concat(Object.keys(Sk.builtins));
	    }	    
            callback(null, wordList.map(function(word) {
              return {
		caption: word,
		value: word,
		meta: "static"
              };
            }));
	    
	  }
	}
	PWS.editor.completers = [staticWordCompleter];

	
	let resp = await fetch(PWS.assignmentRoot+"/main.py");
	let code = await resp.text();
        PWS.editor.session.setValue(code);     
	
	let r = await fetch(PWS.assignmentRoot+"/test.py", {method: 'HEAD'});
	if (r.status != 200) {
	  document.getElementById('test').style.visibility = 'hidden';
	}
	
	r = await fetch(PWS.assignmentRoot+"/init.js", {method: 'HEAD'});	
	if (r.status == 200) {
	  let node = document.createElement('script');
	  node.src = PWS.assignmentRoot+"/init.js";
	  document.body.append(node);
	}
	
	resize();
	
	//PWS.terminal = createTerminal('console')
	
	document.getElementById('loading').style.visibility = 'hidden';
      }

      // attach a file to the DOM so python open can work
      async function load_file_to_DOM(filename) {
	let file_url = window.location.protocol + '//'
	    + window.location.host
	    + window.location.pathname + '/'
	    + PWS.assignmentRoot + '/' + filename;
	console.log('fetching '+file_url);
	f = await fetch(file_url);  
	node = document.createElement('pre');
	node.id = filename;
	node.innerHTML = await f.text();
	document.body.append(node);	
      }


      </script>
  </body>
</html>
