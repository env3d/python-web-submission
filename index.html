<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Python Submission</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/css/ace.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style type="text/css" media="screen">
      body {
	  max-width: 90%;
	  overflow: hidden;
      }
      
      #loading {
	  top: 0;
	  left: 0;	 
	  position: fixed;
	  height: 100vh;
	  width: 100vw;
	  background-color: rgba(128,128,128,0.6);
	  z-index: 99999;
	  text-align: center;
	  font-size: 10em;	  
      }

      #container {
	  display: grid;
	  height: 100vh;
	  width: 100%;
	  grid-template-areas: 'run test'
			       'editor output'
			       'console console';
      }
      
      #run {
	  grid-area: run;
      }
      
      #test {
	  grid-area: test;
      }
      
      #editor {
	  grid-area: editor;
	  width: 60%;
      }
      
      #output {
	  grid-area: output;
	  background-color: white;
	  color: black;
	  overflow: scroll;
	  margino: 0;
      }
      
      #console {
	  margin: 0;
	  grid-area: console;
	  overflow: auto;
	  margin-bottom: 5%;
      }
      
    </style>
  </head>
  <body onresize="resize()">
    <div id="container">
      <div id="run">
	<button onclick="runSkulpt()">Run</button>
      </div>
      <div id="test">
	<button onclick="test()">Test and Submit</button>
      </div>
      <div id="editor"></div>
      <pre id="output"></pre>
      <div id="console"></div>
    </div>
    <div id="loading">
      Grading...
    </div>

    <script src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/src-min-noconflict/ace.min.js"></script>
    <script src="skulpt-dist-master/skulpt.js"></script>
    <script src="skulpt-dist-master/skulpt-stdlib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script> 
    <script src="skulpt-run.js"></script>

    <script>

      function resize() {
	// adjust the width of the editor and container
	let editorWidth = window.getComputedStyle(document.getElementById('editor')).width.replace('px','');	
	let containerWidth = window.getComputedStyle(document.getElementById('container')).width.replace('px','');
	document.getElementById('editor').style.width = (containerWidth*0.6)+'px';
	document.getElementById('output').style.width = (containerWidth*0.4)+'px';
	//document.getElementById('output').style.width = (containerWidth-editorWidth)+'px';
	
	let containerHeight = window.getComputedStyle(document.getElementById('container')).height.replace('px','');
	// adjust the height of all the major elements: run, test, editor, output, console	
	document.getElementById('run').style.height = (containerHeight*0.05)+'px';	
	document.getElementById('test').style.height = (containerHeight*0.05)+'px';		
	document.getElementById('output').style.height = (containerHeight*0.7)+'px';
	document.getElementById('output').style.margin = 0;
	document.getElementById('editor').style.height = (containerHeight*0.7)+'px';		
	document.getElementById('console').style.height = (containerHeight*0.2)+'px';	
	
      }      

      async function load() {      
        window.editor = ace.edit("editor");      
	
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	window.assignmentRoot = urlParams.get('path') || "labs/lab1";
	
	window.editorFontSize = parseInt(urlParams.get('fontsize')) || 12;
	document.getElementById('output').style.fontSize = editorFontSize+"px";
	
	editor.setAutoScrollEditorIntoView(true);
	editor.setTheme("ace/theme/monokai");	
	editor.session.setMode("ace/mode/python");
	editor.setFontSize(editorFontSize);
	
	resp = await fetch(assignmentRoot+"/main.py");
	code = await resp.text();
        editor.session.setValue(code);     

	r = await fetch(assignmentRoot+"/test.py", {method: 'HEAD'});
	if (r.status != 200) {
	  document.getElementById('test').style.visibility = 'hidden';
	}
	resize();

	initSkulpt();

	window.term = new Terminal();
	term.options.fontSize = editorFontSize;
        term.open(document.getElementById('console'));
	term.prompt = () => {
	  term.write('\r\n>>> ');
	};
	term.write('>>> ');
	command = '';
	term.onData(e => {
	  switch (e) {
          case '\u0003': // Ctrl+C
            term.write('^C');
	    term.prompt();
            break;
          case '\r': // Enter
	    //runCommand(term, command);
	    if (command === 'clear') {
	      command = '';
	      term.prompt();
	      term.clear();	      
	      break;
	    }
	    if (command.length > 0) {
	      myPromise = Sk.misceval.asyncToPromise(function() {
		Sk.output = outputConsole;
		return Sk.importMainWithBody("<stdin>", false, `${command}`, true);
	      });
	      myPromise.then(function(mod) {
		console.log('success');
		Sk.output = output;		
		command = ''
		term.prompt();
	      }, function(err) {
		Sk.output = output;
		term.write('\r\n');
		term.write(err.toString());
		command = ''
		term.prompt();
	      });	      
	    } else {
	      term.prompt();
	    }

            break;
          case '\u007F': // Backspace (DEL)
            // Do not delete the prompt
            if (term._core.buffer.x > 4) {
              term.write('\b \b');
              if (command.length > 0) {
		command = command.substr(0, command.length - 1);
              }
            }
            break;
          default: // Print all other characters for demo
            if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
              command += e;
              term.write(e);
            }
	  }
	});
	
	document.getElementById('loading').style.visibility = 'hidden';
      }

      async function test() {
	document.getElementById('loading').style.visibility = 'visible';
	
	window.pyodide = await loadPyodide();
	pyodide.runPython(
	  [`with open('turtle.py','w') as f:`,
	   `    f.write("from unittest.mock import MagicMock\\n")`,
	   `    f.write("def Turtle():\\n")`,
	   `    f.write("    return MagicMock()\\n")`
	  ].join('\n')
	);
      
	user_content = "with open('main.py', 'w') as f:\n"
	user_content += editor.session.getValue().split('\n')
	  .map( (line) => `    f.write("${line.replaceAll('"','\\"')}\\n")`)
	  .join('\n');
	// console.log(user_content);
	
	pyodide.runPython(user_content)
	mainpkg = pyodide.pyimport("main");

	await pyodide.runPythonAsync([
	  `from pyodide.http import pyfetch`,
	  `response = await pyfetch("${assignmentRoot}/test.py")`,
	  `with open("test.py", "wb") as f:`,
	  `    f.write(await response.bytes())`
	].join('\n'));
	testpkg = pyodide.pyimport("test");
	
	runTest = [
	  "import test",
	  "suite = test.unittest.TestLoader().loadTestsFromModule(test)",
	  "result = test.unittest.TextTestRunner().run(suite)"
	].join('\n');	  
	pyodide.runPython(runTest);
	
	window.test_result = pyodide.globals.get('result').toJs()

	
	document.getElementById('output').innerHTML = test_result.errors.toJs().toString()
	  .replace(/&/g, '&amp;')
	  .replace(/</g, '&lt;')
	  .replace(/>/g, '&gt;')
	  .replace(/"/g, '&quot;');
	document.getElementById('output').innerHTML += test_result.failures.toJs().toString()
	  .replace(/&/g, '&amp;')
	  .replace(/</g, '&lt;')
	  .replace(/>/g, '&gt;')
	  .replace(/"/g, '&quot;');
	document.getElementById('output').innerHTML += test_result.toString()
	  .replace(/&/g, '&amp;')
	  .replace(/</g, '&lt;')
	  .replace(/>/g, '&gt;')
	  .replace(/"/g, '&quot;');
	
	document.getElementById('loading').style.visibility = 'hidden';
	term.prompt();
	
      }
      load()
      </script>
  </body>
</html>
