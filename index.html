<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Python Submission</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/css/ace.min.css">
    <style type="text/css" media="screen">
      body {
	  margin: 1em;
      }
      #loading {
	  top: 0;
	  left: 0;	 
	  position: fixed;
	  height: 100vh;
	  width: 100vw;
	  background-color: rgba(128,128,128,0.6);
	  z-index: 99999;
	  text-align: center;
	  font-size: 10em;	  
      }
      #container {
	  display: grid;
	  height: 100vh;
	  width: 100vw;
	  grid-template-areas: 'run','editor','result';
      }
      #run {
	  height: 10vh;
      }
      #editor {
	  grid-area: 'editor';
	  height: 80vh;
	  width: 80vw;
      }
      #result {
	  height: 10vh;
	  grid-area: 'result';	  
      }
    </style>
    <script src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/src-min-noconflict/ace.min.js"></script>
    <script>
      
      async function load() {
	
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);

	window.assignmentRoot = urlParams.get('label') || "labs/lab1";	
	
	window.editor = ace.edit("editor");
	editor.setAutoScrollEditorIntoView(true);
	editor.setTheme("ace/theme/monokai");
	editor.session.setMode("ace/mode/python");
	resp = await fetch(assignmentRoot+"/main.py");
	code = await resp.text();
	editor.session.setValue(code);
	
	document.getElementById('loading').style.visibility = 'hidden';
      }

      async function run() {
	document.getElementById('loading').style.visibility = 'visible';
	
	window.pyodide = await loadPyodide();
	pyodide.runPython(
	  [`with open('turtle.py','w') as f:`,
	   `    f.write("from unittest.mock import MagicMock\\n")`,
	   `    f.write("def Turtle():\\n")`,
	   `    f.write("    return MagicMock()\\n")`
	  ].join('\n')
	);
      
	user_content = "with open('main.py', 'w') as f:\n"
	user_content += editor.session.getValue().split('\n')
	  .map( (line) => `    f.write("${line.replaceAll('"','\\"')}\\n")`)
	  .join('\n');
	// console.log(user_content);
	pyodide.runPython(user_content)
	mainpkg = pyodide.pyimport("main");

	await pyodide.runPythonAsync([
	  `from pyodide.http import pyfetch`,
	  `response = await pyfetch("${assignmentRoot}/test.py")`,
	  `with open("test.py", "wb") as f:`,
	  `    f.write(await response.bytes())`
	].join('\n'));
	testpkg = pyodide.pyimport("test");
	
	runTest = [
	  "import test",
	  "suite = test.unittest.TestLoader().loadTestsFromModule(test)",
	  "result = test.unittest.TextTestRunner().run(suite)"
	].join('\n');	  
	pyodide.runPython(runTest);
	
	window.test_result = pyodide.globals.get('result').toJs()
	
	document.getElementById('loading').style.visibility = 'hidden';	
	document.getElementById('result').innerHTML = test_result.toString()
	  .replace(/&/g, '&amp;')
	  .replace(/</g, '&lt;')
	  .replace(/>/g, '&gt;')
	  .replace(/"/g, '&quot;');
      }      
      </script>
  </head>
  <body>
    <div id="container">
      <div id="run">
	<button onclick="run()">Submit</button>
      </div>
      <div id="editor">
      </div>
      <div id="result">
	result
      </div>
    </div>
    <div id="loading">
      Grading...
    </div>    
    <script>
      load()
    </script>
  </body>
</html>
