<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Python Submission</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/css/ace.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
    <style type="text/css" media="screen">
      body {
	  max-width: 90%;
	  overflow: hidden;
      }
      
      #loading {
	  top: 0;
	  left: 0;	 
	  position: fixed;
	  height: 100vh;
	  width: 100vw;
	  background-color: rgba(128,128,128,0.6);
	  z-index: 99999;
	  text-align: center;
	  font-size: 10em;	  
      }

      #container {
	  display: grid;
	  height: 100vh;
	  width: 100%;
	  grid-template-areas: 'run test'
			       'editor output'
			       'console console';
      }
      
      #run {
	  grid-area: run;
      }
      
      #test {
	  grid-area: test;
      }
      
      #editor {
	  grid-area: editor;
	  width: 60%;
      }
      
      #output {
	  grid-area: output;
	  background-color: white;
	  color: black;
	  overflow: scroll;
	  margino: 0;
      }
      
      #console {
	  margin: 0;
	  grid-area: console;
	  overflow: auto;
	  margin-bottom: 5%;
      }
      
    </style>
  </head>
  <body onload="load()" onresize="resize()">
    <div id="container">
      <div id="run">
	<button onclick="window.runPython()">Run</button>
      </div>
      <div id="test">
	<button onclick="runTest()">Test and Submit</button>
      </div>
      <div id="editor"></div>
      <pre id="output"></pre>
      <div id="console"></div>      
    </div>
    <div id="loading">
      Grading...
    </div>

    <script src='https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.30.0/src-min-noconflict/ace.min.js"></script>
    <script src="skulpt-dist-master/skulpt.js"></script>
    <script src="skulpt-dist-master/skulpt-stdlib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script> 
    <script src="skulpt-run.js"></script>
    <script src="pyodide-run.js"></script>
    <script src="terminal.js"></script>
    
    <script>

      function resize() {
	// adjust the width of the editor and container
	let editorWidth = window.getComputedStyle(document.getElementById('editor')).width.replace('px','');	
	let containerWidth = window.getComputedStyle(document.getElementById('container')).width.replace('px','');
	document.getElementById('editor').style.width = (containerWidth*0.6)+'px';
	document.getElementById('output').style.width = (containerWidth*0.4)+'px';
	//document.getElementById('output').style.width = (containerWidth-editorWidth)+'px';
	
	let containerHeight = window.getComputedStyle(document.getElementById('container')).height.replace('px','');
	// adjust the height of all the major elements: run, test, editor, output, console	
	document.getElementById('run').style.height = (containerHeight*0.05)+'px';	
	document.getElementById('test').style.height = (containerHeight*0.05)+'px';		
	document.getElementById('output').style.height = (containerHeight*0.7)+'px';
	document.getElementById('output').style.margin = 0;
	document.getElementById('editor').style.height = (containerHeight*0.7)+'px';		
	document.getElementById('console').style.height = (containerHeight*0.2)+'px';	
      }

      async function load() {
	
	// Set the default interactive python runtime
	window.runPython = runSkulpt;
        window.editor = ace.edit("editor");      
	
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(queryString);
	window.assignmentRoot = urlParams.get('path') || "labs/lab1";
	
	window.editorFontSize = parseInt(urlParams.get('fontsize')) || 12;
	document.getElementById('output').style.fontSize = editorFontSize+"px";
	
	editor.setAutoScrollEditorIntoView(true);
	editor.setTheme("ace/theme/monokai");	
	editor.session.setMode("ace/mode/python");
	editor.setFontSize(editorFontSize);
	
	resp = await fetch(assignmentRoot+"/main.py");
	code = await resp.text();
        editor.session.setValue(code);     

	r = await fetch(assignmentRoot+"/test.py", {method: 'HEAD'});
	if (r.status != 200) {
	  document.getElementById('test').style.visibility = 'hidden';
	}

	r = await fetch(assignmentRoot+"/init.js", {method: 'HEAD'});	
	if (r.status == 200) {
	  node = document.createElement('script');
	  node.src = assignmentRoot+"/init.js";
	  document.body.append(node);
	}

	resize();
	initSkulpt();
	
	window.term = createTerminal('console') 
	
	document.getElementById('loading').style.visibility = 'hidden';
      }

      // attach a file to the DOM so python open can work
      async function load_file_to_DOM(filename) {
	let file_url = window.location.protocol + '//'
	    + window.location.host
	    + window.location.pathname + '/'
	    + window.assignmentRoot + '/' + filename;
	f = await fetch(file_url);  
	node = document.createElement('pre');
	node.id = filename;
	node.innerHTML = await f.text();
	document.body.append(node);	
      }


      </script>
  </body>
</html>
